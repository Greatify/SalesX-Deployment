name: Build Mobile Apps with EAS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build for'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      branch:
        description: 'Branch to build from'
        required: true
        type: string
        default: 'main'
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - all
        default: 'all'

jobs:
  build-android:
    name: Build Android
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout SalesX source code
        uses: actions/checkout@v4
        with:
          repository: 'Greatify/SalesX'
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: ðŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: mobile
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ”§ Setup Expo and EAS
        run: |
          npm install -g eas-cli
          eas --version
      
      - name: ðŸš€ Build Android with EAS
        working-directory: mobile
        run: |
          eas build \
            --platform android \
            --profile ${{ github.event.inputs.environment }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: ðŸ“¥ Download Android APK from EAS
        working-directory: mobile
        run: |
          # Get the latest build URL
          BUILD_URL=$(eas build:list --platform=android --limit=1 --json --non-interactive | jq -r '.[0].artifacts.buildUrl')
          echo "Downloading APK from: $BUILD_URL"
          
          # Download the APK
          curl -L -o SalesX-latest.apk "$BUILD_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: ðŸ“¤ Upload Android APK to S3
        working-directory: mobile
        run: |
          S3_KEY="mobile/android/release/SalesX-latest.apk"
          
          # Upload to S3 with proper headers for APK download
          aws s3 cp SalesX-latest.apk "s3://salesx-greatify/$S3_KEY" \
            --content-type "application/vnd.android.package-archive" \
            --content-disposition "attachment; filename=SalesX-latest.apk" \
            --metadata-directive REPLACE \
            --cache-control "no-cache, no-store, must-revalidate"
          
          # Generate CloudFront URL
          S3_CLOUDFRONT_URL="${{ secrets.S3_CLOUDFRONT_URL }}/$S3_KEY"
          echo "âœ… Android APK uploaded to: $S3_CLOUDFRONT_URL"
          echo "ANDROID_URL=$S3_CLOUDFRONT_URL" >> $GITHUB_ENV
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      
      - name: ðŸš€ Publish OTA Update
        working-directory: mobile
        run: |
          echo "Publishing OTA update to ${{ github.event.inputs.environment }} channel..."
          eas update \
            --channel ${{ github.event.inputs.environment }} \
            --message "Build ${{ github.event.inputs.environment }} from ${{ github.event.inputs.branch }}" \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: ðŸ“‹ Android Build Summary
        run: |
          echo "### âœ… Android Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download APK:**" >> $GITHUB_STEP_SUMMARY
          echo "https://secure.klockwork.ai/mobile/android/release/SalesX-latest.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Open the APK link on your Android device" >> $GITHUB_STEP_SUMMARY
          echo "2. Allow installation from unknown sources" >> $GITHUB_STEP_SUMMARY
          echo "3. Install the app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ OTA Update Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Channel:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How OTA Updates Work:**" >> $GITHUB_STEP_SUMMARY
          echo "- Existing apps will auto-check for updates on launch" >> $GITHUB_STEP_SUMMARY
          echo "- Update downloads in background" >> $GITHUB_STEP_SUMMARY
          echo "- User sees 'Update Ready! Restart to apply' modal" >> $GITHUB_STEP_SUMMARY
          echo "- Updates apply within minutes without reinstalling APK" >> $GITHUB_STEP_SUMMARY
  
  build-ios:
    name: Build iOS and Submit to TestFlight
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout SalesX source code
        uses: actions/checkout@v4
        with:
          repository: 'Greatify/SalesX'
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: ðŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: mobile
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ”§ Setup Expo and EAS
        run: |
          npm install -g eas-cli
          eas --version
      
      - name: ðŸš€ Build iOS with EAS
        working-directory: mobile
        run: |
          eas build \
            --platform ios \
            --profile production \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      
      - name: ðŸ“¥ Download iOS IPA from EAS
        working-directory: mobile
        run: |
          # Get the latest build URL
          BUILD_URL=$(eas build:list --platform=ios --limit=1 --json --non-interactive | jq -r '.[0].artifacts.buildUrl')
          echo "Downloading IPA from: $BUILD_URL"
          
          # Download the IPA
          curl -L -o SalesX.ipa "$BUILD_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: ðŸ“¤ Upload iOS IPA to S3
        working-directory: mobile
        run: |
          S3_KEY="mobile/ios/release/SalesX-latest.ipa"
          
          # Upload to S3 with proper headers
          aws s3 cp SalesX.ipa "s3://salesx-greatify/$S3_KEY" \
            --content-type "application/octet-stream" \
            --content-disposition "attachment; filename=SalesX-latest.ipa" \
            --metadata-directive REPLACE \
            --cache-control "no-cache, no-store, must-revalidate"
          
          # Generate CloudFront URL
          S3_CLOUDFRONT_URL="${{ secrets.S3_CLOUDFRONT_URL }}/$S3_KEY"
          echo "âœ… iOS IPA uploaded to: $S3_CLOUDFRONT_URL"
          echo "IOS_IPA_URL=$S3_CLOUDFRONT_URL" >> $GITHUB_ENV
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      
      - name: ðŸ“¤ Submit to TestFlight
        working-directory: mobile
        run: |
          eas submit \
            --platform ios \
            --latest \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      
      - name: ðŸš€ Publish iOS OTA Update
        working-directory: mobile
        run: |
          echo "Publishing OTA update to production channel..."
          eas update \
            --channel production \
            --message "iOS build from ${{ github.event.inputs.branch }}" \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: ðŸ“‹ iOS Build Summary
        run: |
          echo "### âœ… iOS Build Complete and Submitted to TestFlight!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IPA Backup (S3):**" >> $GITHUB_STEP_SUMMARY
          echo "https://secure.klockwork.ai/mobile/ios/release/SalesX-latest.ipa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**TestFlight Distribution (Recommended):**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "2. Navigate to: My Apps > Your App > TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait 5-15 minutes for build processing" >> $GITHUB_STEP_SUMMARY
          echo "4. Add internal testers (install immediately)" >> $GITHUB_STEP_SUMMARY
          echo "5. Or add external testers (Apple review needed, 2-3 days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation for Testers:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Install TestFlight app from App Store" >> $GITHUB_STEP_SUMMARY
          echo "2. Accept invitation email" >> $GITHUB_STEP_SUMMARY
          echo "3. Tap 'Install' in TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build available in TestFlight within 15 minutes!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ OTA Update Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update Channel:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**How OTA Updates Work:**" >> $GITHUB_STEP_SUMMARY
          echo "- Existing apps will auto-check for updates on launch" >> $GITHUB_STEP_SUMMARY
          echo "- Update downloads in background" >> $GITHUB_STEP_SUMMARY
          echo "- User sees 'Update Ready! Restart to apply' modal" >> $GITHUB_STEP_SUMMARY
          echo "- Updates apply within minutes without reinstalling" >> $GITHUB_STEP_SUMMARY
