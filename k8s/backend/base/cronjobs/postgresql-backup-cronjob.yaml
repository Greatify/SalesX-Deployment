apiVersion: batch/v1
kind: CronJob
metadata:
  name: salesx-postgresql-backup
  labels:
    app: salesx
    component: backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: salesx
            component: backup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: salesx-backend-secret-sa
          volumes:
          - name: salesx-secrets-volume
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: salesx-backend-secrets
          containers:
          - name: postgres-backup
            image: postgres:16-alpine
            volumeMounts:
            - name: salesx-secrets-volume
              mountPath: /mnt/secret-store
              readOnly: true
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              # Load environment variables from secrets
              if [ -f /mnt/secret-store/.env ]; then
                export $(grep -v '^#' /mnt/secret-store/.env | xargs)
              fi
              
              # Extract database credentials from DATABASE_URL
              # Format: postgresql://user:password@host:port/database
              if [ -n "$DATABASE_URL" ]; then
                POSTGRES_USER=$(echo $DATABASE_URL | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
                POSTGRES_PASSWORD=$(echo $DATABASE_URL | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')
                POSTGRES_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:]*\):.*/\1/p')
                POSTGRES_DB=$(echo $DATABASE_URL | sed -n 's/.*\/\([^?]*\).*/\1/p')
              fi
              
              BACKUP_DATE=$(date +%Y-%m-%d_%H-%M-%S)
              BACKUP_FILE="/tmp/salesx-backup-${BACKUP_DATE}.sql.gz"
              S3_PATH="s3://${S3_BACKUP_BUCKET}/postgresql/salesx-backup-${BACKUP_DATE}.sql.gz"
              
              echo "Starting PostgreSQL backup at ${BACKUP_DATE}"
              echo "Database: ${POSTGRES_DB} on ${POSTGRES_HOST}"
              
              # Create backup with pg_dump
              PGPASSWORD=${POSTGRES_PASSWORD} pg_dump \
                -h ${POSTGRES_HOST} \
                -U ${POSTGRES_USER} \
                -d ${POSTGRES_DB} \
                -F c \
                --no-owner \
                --no-acl \
                | gzip > ${BACKUP_FILE}
              
              echo "Backup created: ${BACKUP_FILE}"
              
              # Install AWS CLI
              apk add --no-cache aws-cli python3 py3-pip
              
              # Upload to S3
              aws s3 cp ${BACKUP_FILE} ${S3_PATH} \
                --region ${AWS_REGION} \
                --storage-class STANDARD_IA
              
              echo "Backup uploaded to ${S3_PATH}"
              
              # Delete local backup file
              rm -f ${BACKUP_FILE}
              
              # Delete backups older than 7 days
              echo "Cleaning up old backups (>7 days)"
              aws s3 ls s3://${S3_BACKUP_BUCKET}/postgresql/ | \
                while read -r line; do
                  createDate=$(echo $line | awk {'print $1" "$2'})
                  createDate=$(date -d "$createDate" +%s)
                  olderThan=$(date --date '7 days ago' +%s)
                  if [[ $createDate -lt $olderThan ]]; then
                    fileName=$(echo $line | awk {'print $4'})
                    if [[ $fileName != "" ]]; then
                      echo "Deleting old backup: $fileName"
                      aws s3 rm s3://${S3_BACKUP_BUCKET}/postgresql/$fileName
                    fi
                  fi
                done
              
              echo "Backup completed successfully"
            env:
            - name: S3_BACKUP_BUCKET
              value: "salesx-greatify"
            - name: AWS_REGION
              value: "ap-south-1"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: salesx-backup-secrets
                  key: aws-access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: salesx-backup-secrets
                  key: aws-secret-access-key
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
